// ==UserScript==
// @name         YouTube Liked Videos Mass Unliker (Fixed August 2025)
// @namespace    https://greasyfork.org/en/users/you
// @version      2.1
// @description  Remove all liked videos from your "Liked Videos" playlist safely
// @author       ChatGPT (fixes on Dag7)
// @match        https://www.youtube.com/playlist?list=LL*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    const SCROLL_DELAY = 3000;
    const DELETION_DELAY = 1500;

    let removedCount = 0;

    const log = (msg) => {
        console.log("[Unliker]", msg);
        const box = document.getElementById('yt-unlike-log');
        if (box) {
            box.innerHTML += `<div>${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }
    };

    const addLogBox = () => {
        const box = document.createElement("div");
        box.id = "yt-unlike-log";
        box.style = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: #000;
            color: #0f0;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
            border: 1px solid #0f0;
            z-index: 9999;
        `;
        document.body.appendChild(box);
    };

    const addButton = () => {
        const button = document.createElement("button");
        button.textContent = "🚫 Unlike All Videos";
        button.style = `
            position: fixed;
            top: 270px;
            right: 10px;
            padding: 10px;
            background: red;
            color: white;
            border: none;
            font-size: 14px;
            z-index: 9999;
            cursor: pointer;
        `;
        button.onclick = main;
        document.body.appendChild(button);
    };

    const delay = (ms) => new Promise((res) => setTimeout(res, ms));

    async function scrollAndCollectVideos() {
        let lastCount = 0;
        let videos = [];

        do {
            lastCount = videos.length;
            window.scrollBy(0, 2000);
            await delay(SCROLL_DELAY);
            videos = Array.from(document.querySelectorAll("ytd-playlist-video-renderer"));
            log(`Detected ${videos.length} videos...`);
        } while (videos.length !== lastCount);

        return videos;
    }

    async function clickMenuAndUnlike(video) {
        try {
            const menuBtn = video.querySelector('#button[aria-label]');
            if (!menuBtn) return false;

            menuBtn.click();
            await delay(500);

            // Find all menu items
            let items = document.querySelectorAll('ytd-menu-service-item-renderer tp-yt-paper-item');
            let found = false;
            for (let item of items) {
                if (item.textContent.toLowerCase().includes('remove from')) {
                    item.click();
                    found = true;
                    removedCount++;
                    break;
                }
            }

            if (!found) {
                log("❌ 'Remove from playlist' not found.");
            } else {
                log(`✅ Removed video #${removedCount}`);
            }

            return found;
        } catch (e) {
            log("⚠️ Error unliking: " + e.message);
            return false;
        }
    }

    async function main() {
        log("🚀 Starting unlike process...");
        const videos = await scrollAndCollectVideos();
        log(`🎯 Total videos found: ${videos.length}`);

        for (let video of videos) {
            await clickMenuAndUnlike(video);
            await delay(DELETION_DELAY);
        }

        log(`🎉 Done! Total removed: ${removedCount}`);
    }

    // Run setup
    window.addEventListener('load', () => {
        setTimeout(() => {
            addLogBox();
            addButton();
            log("✅ Script loaded. Click '🚫 Unlike All Videos' to start.");
        }, 3000);
    });
})();

// ==UserScript==
// @name         YouTube Liked Videos True Unliker (Simulated Click - Aug 2025)
// @namespace    http://tampermonkey.net/
// @version      9.0
// @description  Accurately unlikes liked videos using simulated real clicks on the like button â€” YouTube Shadow DOM/React fix (August 2025). Includes UI and logging.
// @author       ChatGPT
// @match        *://www.youtube.com/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    const DELAY = 2500;
    let processed = new Set();
    let running = false;

    function createLogBox() {
        const box = document.createElement('div');
        box.id = 'unlike-box';
        Object.assign(box.style, {
            position: 'fixed',
            top: '10px',
            right: '10px',
            background: '#111',
            color: '#0f0',
            padding: '10px',
            zIndex: 999999,
            fontSize: '13px',
            fontFamily: 'monospace',
            maxHeight: '250px',
            overflowY: 'auto',
            borderRadius: '8px',
            boxShadow: '0 0 10px rgba(0,255,0,0.4)'
        });
        box.innerHTML = '<b>ðŸŸ¢ YouTube Mass Unliker</b><br>';
        document.body.appendChild(box);
    }

    function logBox(text, color = '#0f0') {
        const box = document.getElementById('unlike-box');
        if (!box) return;
        const line = document.createElement('div');
        line.textContent = text;
        line.style.color = color;
        box.appendChild(line);
        box.scrollTop = box.scrollHeight;
        console.log(text);
    }

    function simulateRealClick(element) {
        if (!element) return;
        const evt = new MouseEvent('click', {
            bubbles: true,
            cancelable: true,
            view: window
        });
        element.dispatchEvent(evt);
    }

    async function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function scrollDown() {
        window.scrollBy(0, 3000);
    }

    function isLikedVideosPage() {
        return new URLSearchParams(location.search).get("list") === "LL";
    }

    async function unlikeVisibleVideos() {
        const videoItems = document.querySelectorAll('ytd-playlist-video-renderer');

        for (let item of videoItems) {
            const videoId = item.dataset.videoId;
            const title = item.querySelector('#video-title')?.textContent.trim() || 'Untitled';

            if (processed.has(videoId)) continue;

            // Find the like button that is active (aria-pressed="true")
            const likeBtn = item.querySelector('ytd-toggle-button-renderer button[aria-pressed="true"]');

            if (likeBtn) {
                simulateRealClick(likeBtn);
                processed.add(videoId);
                logBox(`ðŸ‘ Unliked: ${title}`);
                await sleep(DELAY);
            } else {
                logBox(`â­ï¸ Skipped or already unliked: ${title}`, '#aaa');
            }
        }
    }

    async function run() {
        if (running) return;
        running = true;

        logBox('âœ… Starting to unlike liked videos...');
        while (true) {
            scrollDown();
            await sleep(1000);
            await unlikeVisibleVideos();
        }
    }

    function init() {
        createLogBox();

        const check = setInterval(() => {
            if (isLikedVideosPage()) {
                const items = document.querySelectorAll('ytd-playlist-video-renderer');
                if (items.length > 0) {
                    clearInterval(check);
                    logBox('ðŸŽ¯ Playlist detected. Running script...');
                    run();
                } else {
                    logBox('âŒ› Waiting for videos to load...', '#ff0');
                }
            }
        }, 1500);
    }

    window.addEventListener('load', init);
})();

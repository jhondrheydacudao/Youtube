// ==UserScript==
// @name         YouTube Auto Unsubscribe All (WORKING)
// @namespace    https://youtube.com/
// @version      2.0
// @description  Automatically unsubscribes from all YouTube channels on /feed/channels and shows progress notifications.
// @author       Jhon DRHEY
// @match        https://www.youtube.com/feed/channels
// @grant        GM_notification
// ==/UserScript==

(function () {
    'use strict';

    let total = 0;
    let unsubscribed = 0;
    let scrollAttempts = 0;
    const maxScrollAttempts = 20;

    function notify(title, text) {
        GM_notification({
            title: title,
            text: text,
            timeout: 4000,
            onclick: function () {
                window.focus();
            }
        });
    }

    function autoScroll(callback) {
        const scrollInterval = setInterval(() => {
            const beforeHeight = document.documentElement.scrollHeight;
            window.scrollTo(0, beforeHeight);
            scrollAttempts++;

            if (scrollAttempts >= maxScrollAttempts) {
                clearInterval(scrollInterval);
                notify('Scroll Complete', 'Finished loading channels. Starting unsubscribe...');
                callback();
            }
        }, 1500);
    }

    function startUnsubscribing() {
        const buttons = Array.from(document.querySelectorAll('ytd-channel-renderer tp-yt-paper-button[aria-label*="Subscribed"]'));
        total = buttons.length;

        if (total === 0) {
            notify('YouTube Auto Unsubscribe', 'No subscriptions found or already unsubscribed.');
            return;
        }

        notify('Starting Unsubscribe', `Found ${total} subscriptions.`);

        let delay = 0;
        buttons.forEach((btn, i) => {
            setTimeout(() => {
                btn.click();

                setTimeout(() => {
                    const confirmBtn = document.querySelector('yt-confirm-dialog-renderer tp-yt-paper-button#confirm-button');
                    if (confirmBtn) {
                        confirmBtn.click();
                        unsubscribed++;
                        notify(`Unsubscribed (${unsubscribed}/${total})`, `Channel ${i + 1} unsubscribed.`);
                    }
                }, 700);

            }, delay);

            delay += 2000; // delay between each unsubscribe to avoid rate limits
        });
    }

    window.addEventListener('load', () => {
        notify('YouTube Auto Unsubscribe', 'Preparing to scroll and fetch all channels...');
        setTimeout(() => {
            autoScroll(startUnsubscribing);
        }, 3000);
    });

})();
